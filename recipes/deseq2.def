Bootstrap: docker
From: ubuntu:{{ OS_VERSION }}

%arguments
	OS_VERSION=18.04
	R_VERSION=3.4.1

%help
R ({{ OS_VERSION }}) container for RNA-Seq analysis with DESEq2

%labels
	Software R
	Software.version {{ R_VERSION }}
	Recipe.version 1.0
	Maintainer leo.jourdain@etu-upsaclay.fr/jaffar.gura@etu-upsaclay.fr

%post
	export DEBIAN_FRONTEND=noninteractive
	apt update && apt install -y \
	build-essential \
	gfortran \
	libxml2-dev \
	libgfortran3 \
	libssl-dev \
	libcurl4-openssl-dev \
	libcurl4 \
	xorg-dev \
	libxt-dev \
	libstdc++6 \
	wget

	sed -i.bak "/^#.*deb-src.*universe$/s/^# //g" /etc/apt/sources.list \
	&& apt update \
	&& apt build-dep -y r-base \
	&& wget -O R-{{ R_VERSION }}.tar.gz https://cran.rstudio.com/src/base/R-3/R-{{ R_VERSION }}.tar.gz \
	&& tar -xzvf R-{{ R_VERSION }}.tar.gz \
	&& cd /R-{{ R_VERSION }} \
	&& ./configure \
	--prefix=/opt/R/{{ R_VERSION }} \
	--with-blas \
	--with-lapack \
	--with-recommended-packages
	
	make
	make install
	cd ..
	wget -O BiocInstaller_1.26.1.tar.gz https://bioconductor.org/packages/3.5/bioc/src/contrib/BiocInstaller_1.26.1.tar.gz \
	&& /opt/R/{{ R_VERSION }}/bin/R CMD INSTALL BiocInstaller_1.26.1.tar.gz \
	&& /opt/R/{{ R_VERSION }}/bin/Rscript -e 'library(BiocInstaller);options(repos = c(CRAN = "https://packagemanager.posit.co/cran/2017-10-10"));biocLite("DESeq2", ask=FALSE, suppressUpdates=TRUE, suppressAutoUpdate=TRUE, dependencies=TRUE, type="source")'


%environment
    export PATH=${PATH}:/opt/R/{{ R_VERSION }}/bin

%runscript
    exec R "$@"
